#!/usr/bin/env node

const { Manga } = require("../models");
const { TO_READ, READING, WAITING } = Manga.Shelf;
const MangaService = require("../services/manga-service");
const db = require("../services/db-service");
const datasource = require("../datasource")
const { pushAllMangaNotifications } = require("../services/push-service");

async function main() {
  console.log("Connecting to database");
  await db.ensureDBConnection();

  // TODO add more shelf
  const filters = {
    shelf: { $in: [TO_READ] },
    isCompleted: false,
  };

  await MangaService.updateMultiple.pushToQueue(filters, true);
  await MangaService.updateMultiple.consumeFromQueue(true, true);
  await pushAllMangaNotifications(true);

  await datasource.closeAllConnections();
  await db.closeDBConnection();
}

main().catch((err) => {
  console.error(err);
  datasource.closeAllConnections();
  db.closeDBConnection();
  process.exit(1);
});
